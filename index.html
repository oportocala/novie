<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<style>

		body { margin: 0; padding: 0; background-color: #bbbbbb;}
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>

<div class="scene-wrapper">

</div>

<script src="bower_components/threex.cannonjs/examples/vendor/three.js/build/three.min.js"></script>
<script src="app/js/oribitControls.js"></script>
<script src="bower_components/threex.cannonjs/vendor/cannon.js/build/cannon.js"></script>
<script src="bower_components/threex.cannonjs/threex.cannonbody.js"></script>
<script src="bower_components/threex.cannonjs/threex.cannonworld.js"></script>
<script src="bower_components/threex.keyboardstate/threex.keyboardstate.js"></script>
<script src="bower_components/howler.js/howler.js"></script>

<!--<script src="app/js/setup.js"></script>
<script src="app/js/geometry.js"></script>
<script src="app/js/loop.js"></script>-->
<script>
    var sound = function () {
        var sounds = {
            impact: new Howl({
                urls: ['sounds/impact.mp3']
            }),
            death: new Howl({
                urls: ['sounds/death.mp3']
            })
        };

        return {
            play: function (id) {
                console.log('want to play:', id);
                if (sounds[id]) {
                    return sounds[id].play();
                }
                return false;
            }
        };
    }();
</script>
<script>

	var d2r = .017453292519943295;

	var scene = new THREE.Scene();
	var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );

	var renderer = new THREE.WebGLRenderer();


	renderer.setSize( window.innerWidth, window.innerHeight );
	document.getElementsByClassName('scene-wrapper').item(0).appendChild( renderer.domElement );

	camera.position.x = 80;
	camera.position.y = 60;
	camera.position.z = 0;


	var updateFcts	= [];
	var worldX  = new THREEx.CannonWorld().start();

	var stoneMaterial	= new CANNON.Material('stone');
	worldX.world.addContactMaterial(new CANNON.ContactMaterial(
			stoneMaterial,
			stoneMaterial,
			0.1,	// friction
			0.1	// Restitution
	));


	var  generateSphere = function (color, y, name) {
		var geometry = new THREE.SphereGeometry(1, 10, 10);
		var material = new THREE.MeshBasicMaterial( { color: color || 0x00000, wireframe: true } );
		var mesh = new THREE.Mesh( geometry, material );

		mesh.position.y = y;
		mesh.isSphere = true;
		scene.add( mesh );


		var physicsBody	= new THREEx.CannonBody({
			mesh	: mesh,
			material: stoneMaterial,
			mass: 100
		}).addTo(worldX);

		mesh.name = physicsBody.name = name;

		physicsBody.body.addEventListener("collide", function(e) {
			if (e.with.userData.object3d.isSphere) {
				console.log(e.with.userData.object3d.name, 'collided with', name);
                sound.play('impact');
			}
		});

		updateFcts.push(function(delta, now){
			physicsBody.update(delta, now)
		});

		//physicsBody.body.angularVelocity.set(0,0,20);


		return physicsBody;
	};


	var plane = function generatePlane() {

		var geometry = new THREE.CubeGeometry(100, 1, 100, 1, 1);
		var material = new THREE.MeshBasicMaterial( { color: 0xffffff } );
		var mesh = new THREE.Mesh( geometry, material );

		mesh.position.y = -.5;

		scene.add(mesh);


		var physicsBody	= new THREEx.CannonBody({
			mesh	: mesh,
			material: stoneMaterial,
			mass	: 0
		})
		.addTo(worldX);


		updateFcts.push(function(delta, now){
			physicsBody.update(delta, now)
		});

		return physicsBody;
	}();





	var keyboard	= new THREEx.KeyboardState(renderer.domElement);
	renderer.domElement.setAttribute("tabIndex", "0");
	renderer.domElement.focus();

	var generateControls = function (target, keys) {
		return function () {
			var speed = 20;
			if ( keyboard.pressed(keys.left) ) {

				target.body.angularVelocity.x = speed;
			} else if( keyboard.pressed(keys.right) ) {
				target.body.angularVelocity.x = -speed;
			} else {
				target.body.angularVelocity.x = 0;
			}

			if ( keyboard.pressed(keys.up) ) {
				target.body.angularVelocity.z = speed;
			} else if( keyboard.pressed(keys.down) ) {
				target.body.angularVelocity.z = -speed;
			} else {
				target.body.angularVelocity.z = 0;
			}
		}
	};

	var redSphere;
	var blueSphere;

	var initScene = function () {
		redSphere = generateSphere(0xff0000, 5, 'red');
		blueSphere = generateSphere(0x0000ff, 2, 'blue');

		updateFcts.push(generateControls(redSphere, {left: 'left', right: 'right', up: 'up', down: 'down'}));
		updateFcts.push(generateControls(blueSphere, {left: 'a', right: 'd', up: 'w', down: 's'}));
	};


	initScene();


	var deathY = -30;

	var sphereDied = function (target) {
		target.isDead = true;
		console.log(target.name, 'died');
        sound.play('death');
		resetScene();
	};

	var resetSphere = function (target) {
		target.body.position.x = target.body.initPosition.x;
		target.body.position.y = target.body.initPosition.y;
		target.body.position.z = target.body.initPosition.z;

		target.body.velocity.x = 0;
		target.body.velocity.y = 0;
		target.body.velocity.z = 0;
	};

	var resetScene = function () {
		resetSphere(redSphere);
		resetSphere(blueSphere);
	};


	updateFcts.push(function() {

		if (blueSphere.body.position.y < deathY && !blueSphere.isDead) {
			sphereDied(blueSphere);
		}

		if (redSphere.body.position.y < deathY && !redSphere.isDead) {
			sphereDied(redSphere);
		}

	});

	updateFcts.push(function() {

		if (plane)
			camera.lookAt(plane.body.position);

		renderer.render( scene, camera );
	});

	// only on keyup
	keyboard.domElement.addEventListener('keyup', function(event){
		if( keyboard.eventMatches(event, 'r') )	{
			document.location = '?';
		}
	});

	var animate = function animate(nowMs){
		// keep looping
		requestAnimationFrame( animate );

		// measure time
		lastTimeMs	= lastTimeMs || nowMs - 1000/60;
		var deltaMs	= Math.min(200, nowMs - lastTimeMs);
		lastTimeMs	= nowMs;


		// call each update function
		updateFcts.forEach(function(updateFn){
			updateFn(deltaMs/1000, nowMs/1000);
		})
	};

	var lastTimeMs = null;
	requestAnimationFrame(animate);
</script>
</body>
</html>